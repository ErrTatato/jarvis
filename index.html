<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Jarvis Realtime</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121826;
      --text: #c9d1d9;
      --accent: #2ea043;
      --muted: #7d8590;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, sans-serif; }
    header { padding:20px; display:flex; align-items:center; justify-content:space-between; background:var(--panel); border-bottom:1px solid var(--border); }
    h1 { margin:0; font-size:18px; font-weight:600; letter-spacing:0.4px; }
    .container { max-width:980px; margin:20px auto; padding:0 20px; }
    .controls { display:flex; gap:12px; align-items:center; }
    button { background:var(--accent); color:white; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.secondary { background:#2d333b; }
    .status { color:var(--muted); font-size:14px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; min-height:180px; }
    .panel h2 { font-size:14px; color:var(--muted); margin:0 0 8px; font-weight:600; letter-spacing:0.2px; }
    .text { white-space:pre-wrap; line-height:1.45; font-size:15px; }
    .meter { height:8px; background:#1f2937; border-radius:999px; overflow:hidden; margin-top:8px; }
    .bar { height:100%; width:0%; background:var(--accent); transition:width 120ms linear; }
    audio { width:100%; margin-top:16px; }

    /* Jarvis orb */
    .orb-wrap { display:flex; align-items:center; justify-content:center; padding:20px; }
    #jarvisOrb {
      width: 110px; height: 110px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #2ea043, #0b0f14 60%);
      box-shadow: 0 0 22px rgba(46,160,67,0.7), inset 0 0 12px rgba(46,160,67,0.5);
      position: relative;
      animation: idlePulse 2s infinite;
    }
    #jarvisOrb::after {
      content: "";
      position: absolute; inset: -8px;
      border-radius: 50%;
      border: 2px solid rgba(46,160,67,0.25);
      animation: ring 2.6s infinite;
    }
    @keyframes idlePulse {
      0% { transform: scale(1); box-shadow: 0 0 12px rgba(46,160,67,0.6), inset 0 0 10px rgba(46,160,67,0.4); }
      50% { transform: scale(1.04); box-shadow: 0 0 28px rgba(46,160,67,1), inset 0 0 16px rgba(46,160,67,0.6); }
      100% { transform: scale(1); box-shadow: 0 0 12px rgba(46,160,67,0.6), inset 0 0 10px rgba(46,160,67,0.4); }
    }
    @keyframes speakingPulse {
      0% { transform: scale(1); box-shadow: 0 0 18px rgba(46,160,67,0.9), inset 0 0 12px rgba(46,160,67,0.6); }
      50% { transform: scale(1.22); box-shadow: 0 0 44px rgba(46,160,67,1), inset 0 0 22px rgba(46,160,67,0.8); }
      100% { transform: scale(1); box-shadow: 0 0 18px rgba(46,160,67,0.9), inset 0 0 12px rgba(46,160,67,0.6); }
    }
    @keyframes ring {
      0% { transform: scale(1); opacity: 0.6; }
      80% { transform: scale(1.25); opacity: 0.0; }
      100% { transform: scale(1.25); opacity: 0.0; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Jarvis Realtime</h1>
    <div class="controls">
      <button id="btn-connect">Connetti</button>
      <button id="btn-disconnect" class="secondary">Disconnetti</button>
      <span id="status" class="status">Idle</span>
    </div>
  </header>

  <div class="container">
    <div class="orb-wrap">
      <div id="jarvisOrb" title="Jarvis orb"></div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Tu (trascrizione live)</h2>
        <div id="youPartial" class="text"></div>
        <div class="meter"><div id="meterBar" class="bar"></div></div>
      </div>
      <div class="panel">
        <h2>Jarvis (risposta)</h2>
        <div id="jarvisText" class="text"></div>
      </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const youPartialEl = document.getElementById('youPartial');
    const jarvisTextEl = document.getElementById('jarvisText');
    const remoteAudio = document.getElementById('remoteAudio');
    const meterBar = document.getElementById('meterBar');
    const orb = document.getElementById('jarvisOrb');

    let pc, serverDC, micStream, meterInterval;

    function setStatus(s) { statusEl.textContent = s; }
    function appendJarvis(text) { jarvisTextEl.textContent += text; }

    function startMeter(stream) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const src = ctx.createMediaStreamSource(stream);
      const analyser = ctx.createAnalyser();
      analyser.fftSize = 512;
      src.connect(analyser);
      const data = new Uint8Array(analyser.frequencyBinCount);
      meterInterval = setInterval(() => {
        analyser.getByteFrequencyData(data);
        let sum = 0;
        for (let i = 0; i < data.length; i++) sum += data[i];
        const avg = sum / data.length;
        const pct = Math.min(100, Math.max(0, (avg / 128) * 100));
        meterBar.style.width = pct.toFixed(0) + "%";
      }, 120);
    }

    // Orb reacts to audio playback
    remoteAudio.onplay = () => { orb.style.animation = "speakingPulse 1s infinite"; };
    remoteAudio.onpause = () => { orb.style.animation = "idlePulse 2s infinite"; };
    remoteAudio.onended = () => { orb.style.animation = "idlePulse 2s infinite"; };

    async function connect() {
      try {
        setStatus('Connessione...');
        jarvisTextEl.textContent = "";
        youPartialEl.textContent = "";

        pc = new RTCPeerConnection();

        // receive server TTS track
        pc.ontrack = (ev) => {
          const [stream] = ev.streams;
          remoteAudio.srcObject = stream;
          setStatus('Audio in arrivo...');
        };

        // server datachannel
        pc.ondatachannel = (ev) => {
          if (ev.channel.label === "server") {
            serverDC = ev.channel;
            serverDC.onmessage = (msgEv) => {
              try {
                const data = JSON.parse(msgEv.data);
                if (data.type === "stt_partial") {
                  youPartialEl.textContent = data.text;
                } else if (data.type === "stt_final") {
                  const cur = youPartialEl.textContent;
                  youPartialEl.textContent = cur ? (cur + "\n" + data.text) : data.text;
                } else if (data.type === "llm_delta") {
                  appendJarvis(data.text);
                } else if (data.type === "error") {
                  appendJarvis("\n[Errore] " + data.message + "\n");
                }
              } catch (e) {
                console.warn("DC parse error", e);
              }
            };
          }
        };

        // optional client channel for future commands
        const clientDC = pc.createDataChannel("client");

        // mic
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });
        for (const track of micStream.getTracks()) {
          pc.addTrack(track, micStream);
        }
        startMeter(micStream);

        const offer = await pc.createOffer({ offerToReceiveAudio: true });
        await pc.setLocalDescription(offer);

        const resp = await fetch('/offer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type })
        });
        const answer = await resp.json();
        await pc.setRemoteDescription(answer);

        setStatus('Connesso');
      } catch (err) {
        setStatus('Errore di connessione');
        console.error(err);
      }
    }

    async function disconnect() {
      try {
        if (meterInterval) { clearInterval(meterInterval); meterInterval = null; }
        if (pc) { pc.close(); pc = null; }
        if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
        setStatus('Disconnesso');
        orb.style.animation = "idlePulse 2s infinite";
      } catch (e) {
        console.error(e);
      }
    }

    document.getElementById('btn-connect').onclick = connect;
    document.getElementById('btn-disconnect').onclick = disconnect;
  </script>
</body>
</html>
