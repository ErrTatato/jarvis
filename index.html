<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Jarvis Assistant</title>
<style>
body { font-family: Arial, sans-serif; background:#0d1117; color:#c9d1d9; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
button { background:#238636;color:white;border:none;border-radius:10px;padding:15px 25px;font-size:18px;cursor:pointer;margin-top:20px; }
button:hover { background:#2ea043; }
#status{margin-top:15px;font-size:18px;}
</style>
</head>
<body>
<h1>üéôÔ∏è Jarvis pronto</h1>
<button id="start-btn">Attiva ascolto</button>
<p id="status">Stato: inattivo</p>
<audio id="jarvis-voice" autoplay></audio>

<script>
let mediaRecorder, audioChunks=[], audioPlayer=document.getElementById('jarvis-voice');

document.getElementById("start-btn").addEventListener("click", async ()=>{
    try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => {
            if(e.data.size>0) sendAudioChunk(e.data);
        };
        mediaRecorder.start(500); // chunk ogni 500ms
        document.getElementById("status").innerText="üéß Ascolto attivo...";
    }catch(e){alert("Errore microfono: "+e.message);}
});

async function sendAudioChunk(blob){
    const arrayBuffer=await blob.arrayBuffer();
    const base64Chunk=btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
    const resp=await fetch('/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({audio_base64:base64Chunk})});
    const data=await resp.json();
    if(data.audio_base64){
        const audioBlob=base64ToBlob(data.audio_base64,"audio/mp3");
        audioPlayer.src=URL.createObjectURL(audioBlob);
    }
}

function base64ToBlob(base64,type="audio/mpeg"){
    const binary=atob(base64);
    const array=[];
    for(let i=0;i<binary.length;i++) array.push(binary.charCodeAt(i));
    return new Blob([new Uint8Array(array)],{type});
}
</script>
</body>
</html>
