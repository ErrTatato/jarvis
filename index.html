<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Jarvis Client</title>
</head>
<body>
<h1>Jarvis è pronto!</h1>
<button id="start-btn">Attiva ascolto</button>
<p id="status">Stato: inattivo</p>
<script>
let recognizing = false;
let recognition;

if (!('webkitSpeechRecognition' in window)) {
    alert("Il tuo browser non supporta Speech Recognition!");
} else {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'it-IT';
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onstart = () => {
        recognizing = true;
        document.getElementById('status').innerText = "Stato: in ascolto...";
    };

    recognition.onend = () => {
        recognizing = false;
        document.getElementById('status').innerText = "Stato: inattivo";
    };

    recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                const transcript = event.results[i][0].transcript.trim().toLowerCase();
                if (transcript.includes("jarvis")) {
                    document.getElementById('status').innerText = "✨ Jarvis attivato!";
                    recognition.stop();
                    startJarvisConversation();
                }
            }
        }
    };
}

document.getElementById('start-btn').addEventListener('click', () => {
    if (!recognizing) {
        recognition.start();
    }
});

function startJarvisConversation() {
    const convo = new webkitSpeechRecognition();
    convo.lang = 'it-IT';
    convo.continuous = false;
    convo.interimResults = false;

    convo.onresult = (event) => {
        const userText = event.results[0][0].transcript;
        fetch('/ask', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: userText})
        })
        .then(res => res.json())
        .then(data => {
            alert("Jarvis dice: " + data.answer);
        });
    };
    convo.start();
}
</script>
</body>
</html>
